<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Listener Example (Direct WebSocket)</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      input {
        width: 98%;
        font-size: 10px;
      }
    </style>
    <link rel="stylesheet" href="https://stopsopa.github.io/tabs/vanilla-tabs.css" />
  </head>
  <body>
    <div class="container">
      <a href="../">UP</a>

      <span class="status"></span>
      <a id="clone" target="_blank">Open cloned tabs for testing</a>
      <br />
      <br />

      <div data-vanilla-tabs>
        <div data-buttons>
          <a href="javascript:;" class="active">curl</a>
          <span>event</span>
          <span>event - code example</span>
        </div>
        <div data-tabs>
          <div>
            <p class="tip">
              broadcast from server via curl (including/excluding individual tabs). In this case we are including or
              excluding current tab
            </p>

            <input id="curl1" />
            <input id="curl2" />
            <input id="curl3" />
            <input id="curl4" />
          </div>
          <div>
            <p class="tip">
              <span class="status"></span>
              Send event to other tabs <br />
              To all other tabs in the same browser <br />
              or to all tabs across all browsers if extension is connected to the server
            </p>
            <p class="info">
              When it comes to testing it is good idea to test sending events to other tabs when server is connected to
              see if it is propagating to different browser tabs and also when server is not connected to see if it is
              propagating to all tabs in the current browser
            </p>
            <p class="tip">
              when it comes to testing when not connected use 'node --watch --env-file=.env server/index.js' server mode
              to DON'T run socket this way you can still load http://localhost:8080/tabs_events.html but extensions will
              be offline.
            </p>

            <button id="broadcast">send other_tabs:broadcast event</button>
          </div>
          <div>
            <a
              href="https://github.com/stopsopa/os-browser-bridge?tab=readme-ov-file#from-browser-tab-to-other-tabs-in-all-browsers-except-this-tab"
              >documentation page</a
            >
            <br />
            <a href="https://github.com/stopsopa/os-browser-bridge?tab=readme-ov-file#from-server">server side</a>
            <pre>

// emit event (in browser tab context)
document.documentElement.dispatchEvent(
  new CustomEvent("os_browser_bridge", {
    detail: {
      event: "other_tabs:broadcast",
      payload: { message: "Hello other tabs", unique: unq },
    },
  })
);

// and listen: (in the other tab context)
document.addEventListener("other_tabs:broadcast", (event) => {
  const {
    type, // 'myevent'
    detail, // { message: "Hello other tabs", unique: unq }
  } = event;

  prependToPre(`event: ${type}, detail: ${JSON.stringify(detail)}`);
});

            </pre>
          </div>
        </div>
      </div>
      <br />
      <button id="clear">Clear</button>
      <pre id="logs"></pre>
    </div>

    <script src="https://stopsopa.github.io/tabs/vanilla-tabs.js"></script>
    <script type="importmap">
      {
        "imports": {
          "./bridge.js": "https://stopsopa.github.io/os-browser-bridge/server/public/bridge.js",
          "./tools.js": "https://stopsopa.github.io/os-browser-bridge/extension/tools.js"
        }
      }
    </script>
    <script type="module">
      import { splitOnce, decodeJson, escapeForHtmlAttr } from "./tools.js";

      import { sendIdentifyTabEvent, waitForConnectionStatus, unique } from "./bridge.js";

      document.querySelector("#clone").setAttribute("href", location.href);

      const unbind = vanillaTabs.bind();
      vanillaTabs.active();

      const pre = document.querySelector("#logs");

      function prependToPre(...args) {
        const timeString = new Date().toISOString();
        pre.innerText = `time: ${timeString}, ${args.join(" ")}` + "\n" + pre.innerText;
      }

      {
        // status dot
        function updateStatus(status) {
          const statusElement = document.querySelector(".status");
          statusElement.classList.remove("connected", "disconnected", "connecting", "connection_failed");
          statusElement.classList.add(status);
        }

        /**
         * WARNING: If you planning to listen to
         * document.addEventListener("os_browser_bridge_connection_status", (event) => {
         *   then subscribe to it before wating for waitForConnectionStatus()
         *   because initial event os_browser_bridge_connection_status will arrive before waitForConnectionStatus()
         * }
         */
        document.addEventListener("os_browser_bridge_connection_status", (event) => {
          const {
            type, // "os_browser_bridge_connection_status"
            detail: {
              isConnected, // boolean
              details: {
                state, // "connected"
              },
            },
          } = event;

          console.log("os_browser_bridge_connection_status", {
            type,
            isConnected,
            state,
          });

          updateStatus(state);
        });
      }

      try {
        await waitForConnectionStatus(1500);
      } catch (e) {
        prependToPre("error: " + e.message);
      }

      const event = await sendIdentifyTabEvent();

      const tabId = event?.detail?.tabId;

      prependToPre("tabId:", tabId);

      {
        const curl1 = document.querySelector("#curl1");
        curl1.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa1111"}}' "http://localhost:8080/just_broadcast?event=myevent" | jq`;

        const curl2 = document.querySelector("#curl2");
        curl2.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa2222"}}' "http://localhost:8080/just_broadcast?event=myevent&delay=1000" | jq`;

        const curl3 = document.querySelector("#curl3");
        curl3.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa3333"}}' "http://localhost:8080/just_broadcast?event=myevent&include=${tabId}" | jq`;

        const curl4 = document.querySelector("#curl4");
        curl4.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa4444"}}' "http://localhost:8080/just_broadcast?event=myevent&exclude=${tabId}" | jq`;

        document.addEventListener("click", (event) => {
          if (event.target.matches("[id^='curl']")) {
            event.target.select();
          }
        });
      }

      {
        // listening for incoming events
        document.addEventListener("myevent", (event) => {
          const {
            type, // 'myevent'
            detail, // {def: 'test'}
          } = event;

          prependToPre(`event: ${type}, detail: ${JSON.stringify(detail)}`);
        });

        document.querySelector("#clear").addEventListener("click", () => {
          pre.innerText = "";
        });
      }

      {
        document.addEventListener("other_tabs:broadcast", (event) => {
          const {
            type, // 'myevent'
            detail, // {def: 'test'}
          } = event;

          prependToPre(`event: ${type}, detail: ${JSON.stringify(detail)}`);
        });

        const broadcast = document.querySelector("#broadcast");

        broadcast.addEventListener("click", () => {
          const unq = unique();

          prependToPre(`other_tabs:broadcast event sent: ${unq}`);

          document.documentElement.dispatchEvent(
            new CustomEvent("os_browser_bridge", {
              detail: {
                event: "other_tabs:broadcast",
                payload: { message: "Hello other tabs", unique: unq },
              },
            })
          );
        });
      }
    </script>
  </body>
</html>
