<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Listener Example (Direct WebSocket)</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      input {
        width: 98%;
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="../">UP</a>
      <p class="tip">Testing Direct WebSocket connection browser &lt;-&gt; server</p>

      <button id="clear">Clear</button>
      <pre id="logs"></pre>
      <a href="direct_to_socket.html" target="_blank">Open cloned tabs for testing</a>
      <input id="curl1" />
      <input id="curl2" />
      <input id="curl3" />
      <input id="curl4" />
    </div>

    <script type="module">
      import { splitOnce, decodeJson, escapeForHtmlAttr } from "./tools.js";

      import { sendIdentifyTabEvent, waitForConnectionStatus } from "./bridge.js";

      const pre = document.querySelector("#logs");

      function prependToPre(...args) {
        const timeString = new Date().toISOString();
        pre.innerText = `time: ${timeString}, ${args.join(" ")}` + "\n" + pre.innerText;
      }

      function log(...args) {
        console.log("direct_to_socket.html", ...args);
      }

      await waitForConnectionStatus();

      const event = await sendIdentifyTabEvent();

      const tabId = event?.detail?.tabId;

      prependToPre("tabId:", tabId);

      {
        const curl1 = document.querySelector("#curl1");
        curl1.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa1111"}}' "http://localhost:8080/just_broadcast?event=myevent" | jq`;

        const curl2 = document.querySelector("#curl2");
        curl2.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa2222"}}' "http://localhost:8080/just_broadcast?event=myevent&include=${tabId}" | jq`;

        const curl3 = document.querySelector("#curl3");
        curl3.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa3333"}}' "http://localhost:8080/just_broadcast?event=myevent&delay=1000" | jq`;

        const curl4 = document.querySelector("#curl4");
        curl4.value = `curl -v -X POST -H "Content-Type: application/json" -d '{"payload":{"def":"aaa2222"}}' "http://localhost:8080/just_broadcast?event=myevent&exclude=${tabId}" | jq`;

        [curl1, curl2, curl3, curl4].forEach((input) => {
          input.addEventListener("focus", () => {
            input.select();
          });
        });
      }

      document.addEventListener("myevent", (event) => {
        const {
          type, // 'myevent'
          detail, // {def: 'test'}
        } = event;

        const timeString = new Date().toLocaleTimeString();

        const line = `time: ${timeString}, event: ${type}, detail: ${JSON.stringify(detail)}`;

        log("myevent event:", line);

        prependToPre(line);
      });

      document.querySelector("#clear").addEventListener("click", () => {
        pre.innerText = "";
      });
    </script>
  </body>
</html>
